
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService") -- Для работы с JSON
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local ServerID_to_Rejoin = game.JobId
local ConfigFile = "RejoinerSettings.json" -- Название нашего файла с настройками


local Settings = {
    Enabled = false,
    TimeValue = 30,
    TimeUnit = "Minutes"
}

function SaveConfig()
    local data = HttpService:JSONEncode(Settings)
    writefile(ConfigFile, data)
end

function LoadConfig()
    if isfile(ConfigFile) then
        local data = readfile(ConfigFile)
        local success, decoded = pcall(function() return HttpService:JSONDecode(data) end)
        if success and decoded then
            -- Применяем загруженные настройки
            Settings.Enabled = decoded.Enabled or false
            Settings.TimeValue = decoded.TimeValue or 30
            Settings.TimeUnit = decoded.TimeUnit or "Minutes"
        end
    end
end

LoadConfig()

local Window = Rayfield:CreateWindow({
   Name = "Auto Server Rejoiner",
   LoadingTitle = "Загрузка..."
})

local MainTab = Window:CreateTab("Main", 4483362458)
MainTab:CreateLabel("Rejoining to Server ID: " .. ServerID_to_Rejoin)
MainTab:CreateDivider()

-- Теперь они просто меняют настройки и вызывают SaveConfig()

local TimeInput = MainTab:CreateInput({
   Name = "Time Value", PlaceholderText = "E.g., 0.1", RemoveTextAfterFocusLost = false,
   CurrentValue = Settings.TimeValue, -- Ставим загруженное значение
   Callback = function(text)
      local num = tonumber(text)
      if num and num > 0 then
         Settings.TimeValue = num
         SaveConfig() -- Сохраняем изменение
      end
   end,
})

local TimeUnitDropdown = MainTab:CreateDropdown({
    Name = "Time Unit", Options = {"Minutes", "Hours", "Days"}, CurrentOption = {Settings.TimeUnit},
    MultipleOptions = false,
    Callback = function(option)
        Settings.TimeUnit = option[1]
        SaveConfig() -- Сохраняем изменение
    end,
})

local CountdownLabel = MainTab:CreateLabel("Rejoiner is disabled.")

function RejoinServer()
    Rayfield:Notify({Title = "Rejoining!", Content = "Teleporting back...", Duration = 5})
    pcall(function() TeleportService:TeleportToPlaceInstance(game.PlaceId, ServerID_to_Rejoin, LocalPlayer) end)
end

local secondsRemaining = 0
local isCountingDown = false

task.spawn(function()
    while task.wait(1) do
        if Settings.Enabled and not isCountingDown then
            isCountingDown = true
            local totalSeconds = 0
            if Settings.TimeUnit == "Minutes" then totalSeconds = Settings.TimeValue * 60
            elseif Settings.TimeUnit == "Hours" then totalSeconds = Settings.TimeValue * 3600
            elseif Settings.TimeUnit == "Days" then totalSeconds = Settings.TimeValue * 86400
            end
            secondsRemaining = totalSeconds
        end
        
        if Settings.Enabled and isCountingDown then
            if secondsRemaining > 0 then
                secondsRemaining = secondsRemaining - 1
                local d=math.floor(secondsRemaining/86400);local h=math.floor((secondsRemaining%86400)/3600);local m=math.floor((secondsRemaining%3600)/60);local s=secondsRemaining%60
                CountdownLabel:Set(d > 0 and string.format("Rejoin in: %dд %02d:%02d:%02d", d, h, m, s) or string.format("Rejoin in: %02d:%02d:%02d", h, m, s))
            else
                RejoinServer()
                isCountingDown = false
            end
        elseif not Settings.Enabled and isCountingDown then
            isCountingDown = false; secondsRemaining = 0
            CountdownLabel:Set("Rejoiner stopped.")
        end
    end
end)

local Toggle = MainTab:CreateToggle({
   Name = "Enable Auto Rejoin",
   CurrentValue = Settings.Enabled, -- Ставим загруженное значение
   Callback = function(value)
      Settings.Enabled = value
      SaveConfig() -- Сохраняем изменение
      if not value then
        CountdownLabel:Set("Rejoiner is disabled.")
      else
        Rayfield:Notify({Title = "Timer Started", Content = "The countdown has begun.", Duration = 3})
      end
   end,
})
